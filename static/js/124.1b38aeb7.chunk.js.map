{"version":3,"sources":["routes/posts/2020/12/09-0107-talk-of-sharing-ssr-project/document.mdx"],"names":["readingTime","text","minutes","time","words","layoutProps","MDXLayout","MDXContent","_ref","components","props","Object","_home_runner_work_mzvast_github_io_mzvast_github_io_node_modules_babel_preset_react_app_node_modules_babel_runtime_helpers_esm_objectWithoutProperties__WEBPACK_IMPORTED_MODULE_0__","_mdx_js_react__WEBPACK_IMPORTED_MODULE_2__","assign","mdxType","id","parentName","className","data-language","data-highlighted-line-numbers","dangerouslySetInnerHTML","__html","href","isMDXComponent","tableOfContents","arguments","length","undefined","level","title","children","frontMatter"],"mappings":"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","file":"static/js/124.1b38aeb7.chunk.js","sourcesContent":["\nimport React from 'react'\nimport { mdx } from '@mdx-js/react'\nexport const readingTime = {\"text\":\"1 min read\",\"minutes\":0.86,\"time\":51600,\"words\":172}\n/* @jsx mdx */\n\n\nconst makeShortcode = name => function MDXDefaultShortcode(props) {\n  console.warn(\"Component \" + name + \" was not imported, exported, or provided by MDXProvider as global scope\")\n  return <div {...props}/>\n};\n\nconst layoutProps = {\n  \n};\nconst MDXLayout = \"wrapper\"\nexport default function MDXContent({\n  components,\n  ...props\n}) {\n  return <MDXLayout {...layoutProps} {...props} components={components} mdxType=\"MDXLayout\">\n    <h2 {...{\n      \"id\": \"你可以从本文了解到\"\n    }}>{`你可以从本文了解到`}</h2>\n    <h2 {...{\n      \"id\": \"ssr在官网的应用\"\n    }}>{`SSR在官网的应用`}</h2>\n    <h3 {...{\n      \"id\": \"什么算ssr\"\n    }}>{`什么算SSR`}</h3>\n    <p>{`​\t\t判断标准并不是ReactDOMServer.renderToXXX函数是否在server调用。而是server是否render具体页面内容。（因此，带有renderToXXX也可做CSR）`}</p>\n    <p>{`​\t\t准确来说，我们的React SSR app是个Isomorphic app。即Server render一遍，Client又render（hydrate）一遍。`}</p>\n    <p>{`​\t\thydrate（针对SSR场景特殊优化的render方法）：复用原本已经存在的 DOM 节点，减少重新生成节点以及删除原本 DOM 节点的开销，来加速初次渲染。`}</p>\n    <h3 {...{\n      \"id\": \"ssr工作流程\"\n    }}>{`SSR工作流程`}</h3>\n    <ul>\n      <li parentName=\"ul\">\n        <p parentName=\"li\">{`特点：单线程，计算密集型。`}</p>\n      </li>\n      <li parentName=\"ul\">\n        <p parentName=\"li\">{`同构：UA、canUseWebp`}</p>\n      </li>\n      <li parentName=\"ul\">\n        <p parentName=\"li\">{`非技术优势：所有环境有关的变量都由server掌控。无需通过domain判定环境，不会出现cp01事件。`}</p>\n      </li>\n    </ul>\n    <p>{`注意点⚠️：`}</p>\n    <ol>\n      <li parentName=\"ol\">{`window/global：window在server的回落保护，保护环境。`}</li>\n      <li parentName=\"ol\">{`必要的双重实现：UA侦测、canUseWebp在server和client是两套实现。`}</li>\n    </ol>\n    <p>{`render阶段做的事`}</p>\n    <ol>\n      <li parentName=\"ol\">\n        <p parentName=\"li\">{`路由匹配匹配出页面组件`}</p>\n      </li>\n      <li parentName=\"ol\">\n        <p parentName=\"li\">{`server预加载数据（optional），renderToString并抽取预渲染内容`}</p>\n      </li>\n      <li parentName=\"ol\">\n        <p parentName=\"li\">{`组装产物`}</p>\n      </li>\n    </ol>\n    <h3 {...{\n      \"id\": \"ssg工作流程\"\n    }}>{`SSG工作流程`}</h3>\n    <p>{`render阶段同SSR`}</p>\n    <h3 {...{\n      \"id\": \"csr工作流程\"\n    }}>{`CSR工作流程`}</h3>\n    <p>{`工作流程同SSR，render阶段如下图。`}</p>\n    <ul>\n      <li parentName=\"ul\">{`client端行为与SSR区别：页面加载时需要调用getInitialProps`}</li>\n    </ul>\n    <h3 {...{\n      \"id\": \"如何扛住更多的流量\"\n    }}>{`如何扛住更多的流量`}</h3>\n    <p>{`按不同需求场景，采用不同的渲染方式。`}</p>\n    <ul>\n      <li parentName=\"ul\">\n        <p parentName=\"li\">{`SSG：不需要SEO、不变的页面，用SSG预渲染。然后在SSR的路由判定中适时返回这些文件。`}</p>\n      </li>\n      <li parentName=\"ul\">\n        <p parentName=\"li\">{`CSR：负载压力大的时候，直接切成CSR，增加QPS能力。`}</p>\n      </li>\n      <li parentName=\"ul\">\n        <p parentName=\"li\">{`极端SSR：对于爬虫特殊照顾，通过UA判定，只给他SSR。其他都走CSR/SSG。`}</p>\n      </li>\n    </ul>\n    <h3 {...{\n      \"id\": \"多种render模式结合的工作流程\"\n    }}>{`多种render模式结合的工作流程`}</h3>\n    <h3 {...{\n      \"id\": \"测试性能\"\n    }}>{`测试性能`}</h3>\n    <p>{`工具loadtest or ab`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-shell\",\n        \"data-language\": \"shell\",\n        \"data-highlighted-line-numbers\": \"\",\n        \"dangerouslySetInnerHTML\": {\n          \"__html\": \"<span class=\\\"token comment\\\"># demo</span>\\n<span class=\\\"token function\\\">npm</span> run build:ssr\\n<span class=\\\"token function\\\">npm</span> run <span class=\\\"token builtin class-name\\\">export</span> \\n<span class=\\\"token function\\\">npm</span> run start:prod:test\\n<span class=\\\"token comment\\\"># SSR qps 90</span>\\nloadtest -n <span class=\\\"token number\\\">1000</span> -c <span class=\\\"token number\\\">100</span> <span class=\\\"token string\\\">\\\"http://127.0.0.1:3000/news\\\"</span> -H user-agent:chrome\\n<span class=\\\"token comment\\\"># SSG page qps 1298</span>\\nloadtest -n <span class=\\\"token number\\\">1000</span> -c <span class=\\\"token number\\\">100</span> <span class=\\\"token string\\\">\\\"http://127.0.0.1:3000/xxxx\\\"</span> -H user-agent:chrome\\n<span class=\\\"token comment\\\"># CSR 1012</span>\\nloadtest -n <span class=\\\"token number\\\">1000</span> -c <span class=\\\"token number\\\">100</span> <span class=\\\"token string\\\">\\\"http://127.0.0.1:3000/news\\\"</span> -H user-agent:chrome\\n\"\n        }\n      }}></code></pre>\n    <p>{`可见SSR和CSR有大约10倍的性能差异`}</p>\n    <p>{`SSR本身即app内部渲染逻辑还可以进一步进行性能优化（组件级别的缓存等技术）`}</p>\n    <h2 {...{\n      \"id\": \"坑分享\"\n    }}>{`坑分享`}</h2>\n    <h3 {...{\n      \"id\": \"移动端1px问题\"\n    }}>{`移动端1px问题`}</h3>\n    <ul>\n      <li parentName=\"ul\">\n        <p parentName=\"li\">{`不是新问题。奇数像素宽度导致box模型在部分3x屏幕上下边距`}<inlineCode parentName=\"p\">{`不对称`}</inlineCode>{`。`}</p>\n      </li>\n      <li parentName=\"ul\">\n        <p parentName=\"li\">{`在styled中`}</p>\n        <ul parentName=\"li\">\n          <li parentName=\"ul\">{`编写组件基于transform scale（放大再缩小）`}</li>\n          <li parentName=\"ul\">{`Stylis 插件在运行时根据设备dpr替换组件中的值`}</li>\n        </ul>\n      </li>\n    </ul>\n    <h3 {...{\n      \"id\": \"头图帧动画性能\"\n    }}>{`头图帧动画性能`}</h3>\n    <ul>\n      <li parentName=\"ul\">{`起初实现方案：144张图，js定时切换img的src。缺点：请求数量太多，性能差，兼容性差（某些PC浏览器闪烁）。`}</li>\n      <li parentName=\"ul\">{`改进型：合图144合1，css background动画。缺点：兼容性不算太好（某些情况会闪烁，挑分辨率）`}</li>\n      <li parentName=\"ul\">{`极端型：GIF图，缺点：不能很精确的控制重播。`}</li>\n    </ul>\n    <h3 {...{\n      \"id\": \"移动端返回位置问题\"\n    }}>{`移动端返回位置问题`}</h3>\n    <p>{`问题描述：在Android的某些浏览器中，页面跳转再返回，会回不到之前看的位置（不可思议）。`}</p>\n    <p>{`尝试解决：模拟浏览器记录离开位置，却拿不到稳定值。`}</p>\n    <p>{`aha：useLayoutEffect`}</p>\n    <h3 {...{\n      \"id\": \"unicode编码\"\n    }}>{`unicode编码`}</h3>\n    <p>{`在走查视觉的时候会发现一行字中有两种不同的字体。但看源码中文本并没有什么字体差别。其实文案中存在两种不同范围的 unicode 编码。`}<a parentName=\"p\" {...{\n        \"href\": \"https://blog.csdn.net/gstianfu/article/details/84643320\"\n      }}>{`参见`}</a></p>\n    <p>{`其中用于`}<inlineCode parentName=\"p\">{`部首`}</inlineCode>{`的 unicode，编码范围是从 U+2F00 到 U+2FD5。`}</p>\n    <p>{`另一种用于`}<inlineCode parentName=\"p\">{`常用汉字`}</inlineCode>{`的编码范围是 U+4E00 到 U+9FFF。`}</p>\n    <p>{`显示字体不同原因：在某些 win10 机器的“雅黑”字库中常用汉字字体有映射，另部首则没有，故采用回落字体（等线）显示。`}</p>\n    <p>{`问题产生原因猜测：文案编写者采用的输入法有问题，未按照常用汉字的规范化编码。`}</p>\n    <p>{`目前 unicode 有：NFD（默认）、NFC、NFKD、NFKC 四种规范化形式。英文和一些部首采用 NFD、NFC，而常用汉字采用 NFKD、NFKC 形式。`}</p>\n    <p>{`解决思路：将部首转换到常用汉字编码范围。比如都转换成 NFKD。`}</p>\n    <p>{`ES6 中提供了工具函数`}<a parentName=\"p\" {...{\n        \"href\": \"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/normalize\"\n      }}>{`String.prototype.normalize()`}</a>{`，可以传入参数`}<inlineCode parentName=\"p\">{`\"NFKD\"`}</inlineCode>{`。`}</p>\n    </MDXLayout>;\n}\n\n;\nMDXContent.isMDXComponent = true;\nexport const tableOfContents = (components={}) => [\n  {\n    id: \"你可以从本文了解到\",\n    level: 2,\n    title: \"你可以从本文了解到\",\n    children: [\n        \n      ]\n  },\n{\n    id: \"ssr在官网的应用\",\n    level: 2,\n    title: \"SSR在官网的应用\",\n    children: [\n        {\n              id: \"什么算ssr\",\n              level: 3,\n              title: \"什么算SSR\",\n              children: [\n                      \n                    ]\n            },\n      {\n              id: \"ssr工作流程\",\n              level: 3,\n              title: \"SSR工作流程\",\n              children: [\n                      \n                    ]\n            },\n      {\n              id: \"ssg工作流程\",\n              level: 3,\n              title: \"SSG工作流程\",\n              children: [\n                      \n                    ]\n            },\n      {\n              id: \"csr工作流程\",\n              level: 3,\n              title: \"CSR工作流程\",\n              children: [\n                      \n                    ]\n            },\n      {\n              id: \"如何扛住更多的流量\",\n              level: 3,\n              title: \"如何扛住更多的流量\",\n              children: [\n                      \n                    ]\n            },\n      {\n              id: \"多种render模式结合的工作流程\",\n              level: 3,\n              title: \"多种render模式结合的工作流程\",\n              children: [\n                      \n                    ]\n            },\n      {\n              id: \"测试性能\",\n              level: 3,\n              title: \"测试性能\",\n              children: [\n                      \n                    ]\n            }\n      ]\n  },\n{\n    id: \"坑分享\",\n    level: 2,\n    title: \"坑分享\",\n    children: [\n        {\n              id: \"移动端1px问题\",\n              level: 3,\n              title: \"移动端1px问题\",\n              children: [\n                      \n                    ]\n            },\n      {\n              id: \"头图帧动画性能\",\n              level: 3,\n              title: \"头图帧动画性能\",\n              children: [\n                      \n                    ]\n            },\n      {\n              id: \"移动端返回位置问题\",\n              level: 3,\n              title: \"移动端返回位置问题\",\n              children: [\n                      \n                    ]\n            },\n      {\n              id: \"unicode编码\",\n              level: 3,\n              title: \"unicode编码\",\n              children: [\n                      \n                    ]\n            }\n      ]\n  }\n]\n\nexport const frontMatter = {}\n\n"],"sourceRoot":""}