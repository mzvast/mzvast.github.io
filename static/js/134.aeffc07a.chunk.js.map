{"version":3,"sources":["routes/posts/2021/12/30-1332-Migrate-Razzle-from-3-to-4/document.mdx"],"names":["readingTime","text","minutes","time","words","layoutProps","MDXLayout","MDXContent","_ref","components","props","Object","_home_runner_work_mzvast_github_io_mzvast_github_io_node_modules_babel_preset_react_app_node_modules_babel_runtime_helpers_esm_objectWithoutProperties__WEBPACK_IMPORTED_MODULE_0__","_mdx_js_react__WEBPACK_IMPORTED_MODULE_2__","assign","mdxType","id","parentName","href","className","data-language","data-highlighted-line-numbers","dangerouslySetInnerHTML","__html","isMDXComponent","tableOfContents","arguments","length","undefined","level","title","children","frontMatter"],"mappings":"sSAGaA,EAAc,CAACC,KAAO,aAAaC,QAAU,KAAKC,KAAO,MAAMC,MAAQ,KAS9EC,EAAc,GAGdC,EAAY,UACH,SAASC,EAATC,GAGZ,IAFDC,EAECD,EAFDC,WACGC,EACFC,OAAAC,EAAA,EAAAD,CAAAH,EAAA,gBACD,OAAOG,OAAAE,EAAA,EAAAF,CAACL,EAADK,OAAAG,OAAA,GAAeT,EAAiBK,EAAhC,CAAuCD,WAAYA,EAAYM,QAAQ,cAC5EJ,OAAAE,EAAA,EAAAF,CAAA,KAAQ,CACNK,GAAM,0DADR,0DAGAL,OAAAE,EAAA,EAAAF,CAAA,KAAQ,CACNK,GAAM,gBADR,gBAGAL,OAAAE,EAAA,EAAAF,CAAA,gRACAA,OAAAE,EAAA,EAAAF,CAAA,iJACAA,OAAAE,EAAA,EAAAF,CAAA,KAAQ,CACNK,GAAM,8CADR,8CAGAL,OAAAE,EAAA,EAAAF,CAAA,0FAAoBA,OAAAE,EAAA,EAAAF,CAAA,IAAAA,OAAAG,OAAA,CAAGG,WAAW,KAAQ,CACtCC,KAAQ,8CADQ,2BAApB,UAGAP,OAAAE,EAAA,EAAAF,CAAA,oCAAWA,OAAAE,EAAA,EAAAF,CAAA,IAAAA,OAAAG,OAAA,CAAGG,WAAW,KAAQ,CAC7BC,KAAQ,4CADD,iBAAX,wCAGAP,OAAAE,EAAA,EAAAF,CAAA,KAAQ,CACNK,GAAM,4BADR,4BAGAL,OAAAE,EAAA,EAAAF,CAAA,qCACAA,OAAAE,EAAA,EAAAF,CAAA,WAAKA,OAAAE,EAAA,EAAAF,CAAA,OAAAA,OAAAG,OAAA,CAAMG,WAAW,OAAU,CAC5BE,UAAa,gBACbC,gBAAiB,OACjBC,gCAAiC,GACjCC,wBAA2B,CACzBC,OAAU,mRAGhBZ,OAAAE,EAAA,EAAAF,CAAA,+EACAA,OAAAE,EAAA,EAAAF,CAAA,WAAKA,OAAAE,EAAA,EAAAF,CAAA,OAAAA,OAAAG,OAAA,CAAMG,WAAW,OAAU,CAC5BE,UAAa,gBACbC,gBAAiB,OACjBC,gCAAiC,GACjCC,wBAA2B,CACzBC,OAAU,m0BAGhBZ,OAAAE,EAAA,EAAAF,CAAA,sDACAA,OAAAE,EAAA,EAAAF,CAAA,WAAKA,OAAAE,EAAA,EAAAF,CAAA,OAAAA,OAAAG,OAAA,CAAMG,WAAW,OAAU,CAC5BE,UAAa,gBACbC,gBAAiB,OACjBC,gCAAiC,GACjCC,wBAA2B,CACzBC,OAAU,6SAGhBZ,OAAAE,EAAA,EAAAF,CAAA,2IACAA,OAAAE,EAAA,EAAAF,CAAA,WAAKA,OAAAE,EAAA,EAAAF,CAAA,OAAAA,OAAAG,OAAA,CAAMG,WAAW,OAAU,CAC5BE,UAAa,gBACbC,gBAAiB,OACjBC,gCAAiC,GACjCC,wBAA2B,CACzBC,OAAU,yIAGhBZ,OAAAE,EAAA,EAAAF,CAAA,wLACAA,OAAAE,EAAA,EAAAF,CAAA,+KACAA,OAAAE,EAAA,EAAAF,CAAA,uEAAqBA,OAAAE,EAAA,EAAAF,CAAA,IAAAA,OAAAG,OAAA,CAAGG,WAAW,KAAQ,CACvCC,KAAQ,6CADS,YAArB,6JAGAP,OAAAE,EAAA,EAAAF,CAAA,WAAKA,OAAAE,EAAA,EAAAF,CAAA,OAAAA,OAAAG,OAAA,CAAMG,WAAW,OAAU,CAC5BE,UAAa,gBACbC,gBAAiB,OACjBC,gCAAiC,GACjCC,wBAA2B,CACzBC,OAAU,+jEAGhBZ,OAAAE,EAAA,EAAAF,CAAA,gLACAA,OAAAE,EAAA,EAAAF,CAAA,WAAKA,OAAAE,EAAA,EAAAF,CAAA,OAAAA,OAAAG,OAAA,CAAMG,WAAW,OAAU,CAC5BE,UAAa,cACbC,gBAAiB,KACjBC,gCAAiC,GACjCC,wBAA2B,CACzBC,OAAU,g4RAGhBZ,OAAAE,EAAA,EAAAF,CAAA,6OACAA,OAAAE,EAAA,EAAAF,CAAA,gGACAA,OAAAE,EAAA,EAAAF,CAAA,gDAAaA,OAAAE,EAAA,EAAAF,CAAA,IAAAA,OAAAG,OAAA,CAAGG,WAAW,KAAQ,CAC/BC,KAAQ,sHADC,OAGbP,OAAAE,EAAA,EAAAF,CAAA,wBAASA,OAAAE,EAAA,EAAAF,CAAA,IAAAA,OAAAG,OAAA,CAAGG,WAAW,KAAQ,CAC3BC,KAAQ,+HADH,eAAT,iCAEiCP,OAAAE,EAAA,EAAAF,CAAA,IAAAA,OAAAG,OAAA,CAAGG,WAAW,KAAQ,CACnDC,KAAQ,kHADqB,SAFjC,SAIuBP,OAAAE,EAAA,EAAAF,CAAA,cAAYM,WAAW,KAAvB,qBAJvB,gBAKAN,OAAAE,EAAA,EAAAF,CAAA,iUACAA,OAAAE,EAAA,EAAAF,CAAA,0CAAYA,OAAAE,EAAA,EAAAF,CAAA,IAAAA,OAAAG,OAAA,CAAGG,WAAW,KAAQ,CAC9BC,KAAQ,iHADA,MAAZ,oNAGAP,OAAAE,EAAA,EAAAF,CAAA,WAAKA,OAAAE,EAAA,EAAAF,CAAA,OAAAA,OAAAG,OAAA,CAAMG,WAAW,OAAU,CAC5BE,UAAa,cACbC,gBAAiB,KACjBC,gCAAiC,GACjCC,wBAA2B,CACzBC,OAAU,ggCAGhBZ,OAAAE,EAAA,EAAAF,CAAA,KAAQ,CACNK,GAAM,4BADR,4BAGAL,OAAAE,EAAA,EAAAF,CAAA,6GAAkCA,OAAAE,EAAA,EAAAF,CAAA,IAAAA,OAAAG,OAAA,CAAGG,WAAW,KAAQ,CACpDC,KAAQ,uEADsB,UAGlCP,OAAAE,EAAA,EAAAF,CAAA,mGACAA,OAAAE,EAAA,EAAAF,CAAA,qIACAA,OAAAE,EAAA,EAAAF,CAAA,yBACAA,OAAAE,EAAA,EAAAF,CAAA,WAAKA,OAAAE,EAAA,EAAAF,CAAA,OAAAA,OAAAG,OAAA,CAAMG,WAAW,OAAU,CAC5BE,UAAa,gBACbC,gBAAiB,OACjBC,gCAAiC,GACjCC,wBAA2B,CACzBC,OAAU,uHAGhBZ,OAAAE,EAAA,EAAAF,CAAA,qCACAA,OAAAE,EAAA,EAAAF,CAAA,WAAKA,OAAAE,EAAA,EAAAF,CAAA,OAAAA,OAAAG,OAAA,CAAMG,WAAW,OAAU,CAC5BE,UAAa,eACbC,gBAAiB,MACjBC,gCAAiC,GACjCC,wBAA2B,CACzBC,OAAU,kfAGhBZ,OAAAE,EAAA,EAAAF,CAAA,uDACAA,OAAAE,EAAA,EAAAF,CAAA,KAAQ,CACNK,GAAM,gBADR,gBAGAL,OAAAE,EAAA,EAAAF,CAAA,8JAKJJ,EAAWiB,gBAAiB,EACrB,IAAMC,EAAkB,WAAAC,UAAAC,OAAA,QAAAC,IAAAF,UAAA,IAAAA,UAAA,SAAmB,CAChD,CACEV,GAAI,yDACJa,MAAO,EACPC,MAAO,yDACPC,SAAU,IAId,CACIf,GAAI,eACJa,MAAO,EACPC,MAAO,eACPC,SAAU,IAId,CACIf,GAAI,6CACJa,MAAO,EACPC,MAAO,6CACPC,SAAU,CACN,CACMf,GAAI,2BACJa,MAAO,EACPC,MAAO,2BACPC,SAAU,IAIlB,CACQf,GAAI,2BACJa,MAAO,EACPC,MAAO,2BACPC,SAAU,MAMxB,CACIf,GAAI,eACJa,MAAO,EACPC,MAAO,eACPC,SAAU,MAMDC,EAAc","file":"static/js/134.aeffc07a.chunk.js","sourcesContent":["\nimport React from 'react'\nimport { mdx } from '@mdx-js/react'\nexport const readingTime = {\"text\":\"2 min read\",\"minutes\":1.48,\"time\":88800,\"words\":296}\n/* @jsx mdx */\n\n\nconst makeShortcode = name => function MDXDefaultShortcode(props) {\n  console.warn(\"Component \" + name + \" was not imported, exported, or provided by MDXProvider as global scope\")\n  return <div {...props}/>\n};\n\nconst layoutProps = {\n  \n};\nconst MDXLayout = \"wrapper\"\nexport default function MDXContent({\n  components,\n  ...props\n}) {\n  return <MDXLayout {...layoutProps} {...props} components={components} mdxType=\"MDXLayout\">\n    <h2 {...{\n      \"id\": \"你可以从本文了解到\"\n    }}>{`你可以从本文了解到`}</h2>\n    <h2 {...{\n      \"id\": \"背景\"\n    }}>{`背景`}</h2>\n    <p>{`由于我们的业务需要为 razzle 编写 plugin，而 4 版本的架构理念让一切都 plugin，显然对此提供了更好的支持。`}</p>\n    <p>{`那么我们一起来看看升级的时候会遇到什么坑吧。`}</p>\n    <h2 {...{\n      \"id\": \"过程和遇到问题\"\n    }}>{`过程和遇到问题`}</h2>\n    <p>{`我们演示的项目是我之前建的`}<a parentName=\"p\" {...{\n        \"href\": \"https://github.com/mzvast/cra-ts-ssr-zero\"\n      }}>{`脚手架 demo`}</a>{`。`}</p>\n    <p>{`首先打开`}<a parentName=\"p\" {...{\n        \"href\": \"https://razzlejs.org/docs/upgrade-guide\"\n      }}>{`upgrade-guide`}</a>{`，开始升级！`}</p>\n    <h3 {...{\n      \"id\": \"更新依赖\"\n    }}>{`更新依赖`}</h3>\n    <p>{`执行以下`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-bash\",\n        \"data-language\": \"bash\",\n        \"data-highlighted-line-numbers\": \"\",\n        \"dangerouslySetInnerHTML\": {\n          \"__html\": \"<span class=\\\"token function\\\">yarn</span> <span class=\\\"token function\\\">add</span> --dev <span class=\\\"token punctuation\\\">\\\\</span>\\n  razzle <span class=\\\"token punctuation\\\">\\\\</span>\\n  razzle-dev-utils <span class=\\\"token punctuation\\\">\\\\</span>\\n  babel-preset-razzle\\n\"\n        }\n      }}></code></pre>\n    <p>{`会将相关依赖更新到最新`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-json\",\n        \"data-language\": \"json\",\n        \"data-highlighted-line-numbers\": \"\",\n        \"dangerouslySetInnerHTML\": {\n          \"__html\": \"<span class=\\\"token comment\\\">// package.json</span>\\n<span class=\\\"token punctuation\\\">{</span>\\n    <span class=\\\"token property\\\">\\\"devDependencies\\\"</span><span class=\\\"token operator\\\">:</span> <span class=\\\"token punctuation\\\">{</span>\\n        <span class=\\\"token property\\\">\\\"babel-preset-razzle\\\"</span><span class=\\\"token operator\\\">:</span> <span class=\\\"token string\\\">\\\"^4.2.13\\\"</span><span class=\\\"token punctuation\\\">,</span>\\n        <span class=\\\"token property\\\">\\\"razzle\\\"</span><span class=\\\"token operator\\\">:</span> <span class=\\\"token string\\\">\\\"^4.2.13\\\"</span><span class=\\\"token punctuation\\\">,</span>\\n        <span class=\\\"token property\\\">\\\"razzle-dev-utils\\\"</span><span class=\\\"token operator\\\">:</span> <span class=\\\"token string\\\">\\\"^4.2.13\\\"</span>\\n    <span class=\\\"token punctuation\\\">}</span>\\n<span class=\\\"token punctuation\\\">}</span>\\n\"\n        }\n      }}></code></pre>\n    <p>{`接着安装 peerDependencies`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-bash\",\n        \"data-language\": \"bash\",\n        \"data-highlighted-line-numbers\": \"\",\n        \"dangerouslySetInnerHTML\": {\n          \"__html\": \"<span class=\\\"token function\\\">yarn</span> <span class=\\\"token function\\\">add</span> --dev <span class=\\\"token punctuation\\\">\\\\</span>\\n  webpack-dev-server@3.11.0 <span class=\\\"token punctuation\\\">\\\\</span>\\n  mini-css-extract-plugin@0.9.0 <span class=\\\"token punctuation\\\">\\\\</span>\\n  postcss@8.2.4\\n\"\n        }\n      }}></code></pre>\n    <p>{`以及选择一个 webpack 版本及其插件，这里选择 4 吧。`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-bash\",\n        \"data-language\": \"bash\",\n        \"data-highlighted-line-numbers\": \"\",\n        \"dangerouslySetInnerHTML\": {\n          \"__html\": \"<span class=\\\"token function\\\">yarn</span> <span class=\\\"token function\\\">add</span> --dev webpack@4.46.0 html-webpack-plugin@4.5.2\\n\"\n        }\n      }}></code></pre>\n    <p>{`然后准备 start 我们的 server 看能不能跑，嗯跑起来了，没有任何问题。`}</p>\n    <p>{`如果你的 app 不用读取打包产物 chunks，那么升级到这里就结束了。`}</p>\n    <p>{`但是，如果你的 app 用了`}<a parentName=\"p\" {...{\n        \"href\": \"https://github.com/jaredpalmer/after.js/\"\n      }}>{`After.js`}</a>{`，那么可能编译会报错，提示大概是 webpack 找不到 module 'undefined’。`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-bash\",\n        \"data-language\": \"bash\",\n        \"data-highlighted-line-numbers\": \"\",\n        \"dangerouslySetInnerHTML\": {\n          \"__html\": \"Cannot <span class=\\\"token function\\\">find</span> module <span class=\\\"token string\\\">'undefined'</span>\\n    at webpackEmptyContext <span class=\\\"token punctuation\\\">(</span>/Users/apple/@Projects/oss/cra-ts-ssr-zero/src sync:2:1<span class=\\\"token punctuation\\\">)</span>\\n    at Module<span class=\\\"token punctuation\\\">..</span>/src/server.tsx <span class=\\\"token punctuation\\\">(</span>/Users/apple/@Projects/oss/cra-ts-ssr-zero/build/webpack:/src/server.tsx:19:1<span class=\\\"token punctuation\\\">)</span>\\n    at __webpack_require__ <span class=\\\"token punctuation\\\">(</span>/Users/apple/@Projects/oss/cra-ts-ssr-zero/build/webpack:/webpack/bootstrap:748:1<span class=\\\"token punctuation\\\">)</span>\\n    at fn <span class=\\\"token punctuation\\\">(</span>/Users/apple/@Projects/oss/cra-ts-ssr-zero/build/webpack:/webpack/bootstrap:59:1<span class=\\\"token punctuation\\\">)</span>\\n    at Module<span class=\\\"token punctuation\\\">..</span>/src/index.ts <span class=\\\"token punctuation\\\">(</span>/Users/apple/@Projects/oss/cra-ts-ssr-zero/build/webpack:/src/index.ts:5:1<span class=\\\"token punctuation\\\">)</span>\\n    at __webpack_require__ <span class=\\\"token punctuation\\\">(</span>/Users/apple/@Projects/oss/cra-ts-ssr-zero/build/webpack:/webpack/bootstrap:748:1<span class=\\\"token punctuation\\\">)</span>\\n    at fn <span class=\\\"token punctuation\\\">(</span>/Users/apple/@Projects/oss/cra-ts-ssr-zero/build/webpack:/webpack/bootstrap:59:1<span class=\\\"token punctuation\\\">)</span>\\n    at Object.0 <span class=\\\"token punctuation\\\">(</span>/Users/apple/@Projects/oss/cra-ts-ssr-zero/build/server.js:1622:1<span class=\\\"token punctuation\\\">)</span>\\n    at __webpack_require__ <span class=\\\"token punctuation\\\">(</span>/Users/apple/@Projects/oss/cra-ts-ssr-zero/build/webpack:/webpack/bootstrap:748:1<span class=\\\"token punctuation\\\">)</span>\\n    at /Users/apple/@Projects/oss/cra-ts-ssr-zero/build/webpack:/webpack/bootstrap:815:1\\nsswp<span class=\\\"token operator\\\">></span> <span class=\\\"token operator\\\">!</span><span class=\\\"token operator\\\">!</span><span class=\\\"token operator\\\">!</span> Script exited with code <span class=\\\"token number\\\">1</span>\\n\"\n        }\n      }}></code></pre>\n    <p>{`这个问题跟RAZZLE_CHUNKS_MANIFEST这个环境变量相关。我们来看After的一个demo。`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-ts\",\n        \"data-language\": \"ts\",\n        \"data-highlighted-line-numbers\": \"\",\n        \"dangerouslySetInnerHTML\": {\n          \"__html\": \"<span class=\\\"token comment\\\">// ./src/server.js</span>\\n<span class=\\\"token keyword\\\">import</span> React <span class=\\\"token keyword\\\">from</span> <span class=\\\"token string\\\">'react'</span><span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"token keyword\\\">import</span> express <span class=\\\"token keyword\\\">from</span> <span class=\\\"token string\\\">'express'</span><span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"token keyword\\\">import</span> <span class=\\\"token punctuation\\\">{</span>render<span class=\\\"token punctuation\\\">}</span> <span class=\\\"token keyword\\\">from</span> <span class=\\\"token string\\\">'@jaredpalmer/after'</span><span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"token keyword\\\">import</span> <span class=\\\"token punctuation\\\">{</span>renderToString<span class=\\\"token punctuation\\\">}</span> <span class=\\\"token keyword\\\">from</span> <span class=\\\"token string\\\">'react-dom/server'</span><span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"token keyword\\\">import</span> <span class=\\\"token punctuation\\\">{</span>ApolloProvider<span class=\\\"token punctuation\\\">,</span> getDataFromTree<span class=\\\"token punctuation\\\">}</span> <span class=\\\"token keyword\\\">from</span> <span class=\\\"token string\\\">'react-apollo'</span><span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"token keyword\\\">import</span> routes <span class=\\\"token keyword\\\">from</span> <span class=\\\"token string\\\">'./routes'</span><span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"token keyword\\\">import</span> createApolloClient <span class=\\\"token keyword\\\">from</span> <span class=\\\"token string\\\">'./createApolloClient'</span><span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"token keyword\\\">import</span> Document <span class=\\\"token keyword\\\">from</span> <span class=\\\"token string\\\">'./Document'</span><span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"highlighted-line\\\"><span class=\\\"token keyword\\\">const</span> chunks <span class=\\\"token operator\\\">=</span> <span class=\\\"token keyword\\\">require</span><span class=\\\"token punctuation\\\">(</span>process<span class=\\\"token punctuation\\\">.</span>env<span class=\\\"token punctuation\\\">.</span><span class=\\\"token constant\\\">RAZZLE_CHUNKS_MANIFEST</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span> </span>\\n<span class=\\\"token keyword\\\">const</span> server <span class=\\\"token operator\\\">=</span> <span class=\\\"token function\\\">express</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\nserver\\n    <span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">disable</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token string\\\">'x-powered-by'</span><span class=\\\"token punctuation\\\">)</span>\\n    <span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">use</span><span class=\\\"token punctuation\\\">(</span>express<span class=\\\"token punctuation\\\">.</span><span class=\\\"token keyword\\\">static</span><span class=\\\"token punctuation\\\">(</span>process<span class=\\\"token punctuation\\\">.</span>env<span class=\\\"token punctuation\\\">.</span><span class=\\\"token constant\\\">RAZZLE_PUBLIC_DIR</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">)</span>\\n    <span class=\\\"token punctuation\\\">.</span><span class=\\\"token keyword\\\">get</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token string\\\">'/*'</span><span class=\\\"token punctuation\\\">,</span> <span class=\\\"token keyword\\\">async</span> <span class=\\\"token punctuation\\\">(</span><span class=\\\"token parameter\\\">req<span class=\\\"token punctuation\\\">,</span> res</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n        <span class=\\\"token keyword\\\">const</span> client <span class=\\\"token operator\\\">=</span> <span class=\\\"token function\\\">createApolloClient</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">{</span>ssrMode<span class=\\\"token punctuation\\\">:</span> <span class=\\\"token boolean\\\">true</span><span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n\\n        <span class=\\\"token keyword\\\">const</span> <span class=\\\"token function-variable function\\\">customRenderer</span> <span class=\\\"token operator\\\">=</span> <span class=\\\"token punctuation\\\">(</span><span class=\\\"token parameter\\\">node</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n            <span class=\\\"token keyword\\\">const</span> App <span class=\\\"token operator\\\">=</span> <span class=\\\"token operator\\\">&lt;</span>ApolloProvider client<span class=\\\"token operator\\\">=</span><span class=\\\"token punctuation\\\">{</span>client<span class=\\\"token punctuation\\\">}</span><span class=\\\"token operator\\\">></span><span class=\\\"token punctuation\\\">{</span>node<span class=\\\"token punctuation\\\">}</span><span class=\\\"token operator\\\">&lt;</span><span class=\\\"token operator\\\">/</span>ApolloProvider<span class=\\\"token operator\\\">></span><span class=\\\"token punctuation\\\">;</span>\\n            <span class=\\\"token keyword\\\">return</span> <span class=\\\"token function\\\">getDataFromTree</span><span class=\\\"token punctuation\\\">(</span>App<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">then</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n                <span class=\\\"token keyword\\\">const</span> initialApolloState <span class=\\\"token operator\\\">=</span> client<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">extract</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n                <span class=\\\"token keyword\\\">const</span> html <span class=\\\"token operator\\\">=</span> <span class=\\\"token function\\\">renderToString</span><span class=\\\"token punctuation\\\">(</span>App<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n                <span class=\\\"token keyword\\\">return</span> <span class=\\\"token punctuation\\\">{</span>html<span class=\\\"token punctuation\\\">,</span> initialApolloState<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">;</span>\\n            <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n        <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">;</span>\\n\\n        <span class=\\\"token keyword\\\">try</span> <span class=\\\"token punctuation\\\">{</span>\\n            <span class=\\\"token keyword\\\">const</span> html <span class=\\\"token operator\\\">=</span> <span class=\\\"token keyword\\\">await</span> <span class=\\\"token function\\\">render</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">{</span>\\n                req<span class=\\\"token punctuation\\\">,</span>\\n                res<span class=\\\"token punctuation\\\">,</span>\\n                routes<span class=\\\"token punctuation\\\">,</span>\\n<span class=\\\"highlighted-line\\\">                chunks<span class=\\\"token punctuation\\\">,</span></span>                customRenderer<span class=\\\"token punctuation\\\">,</span>\\n                document<span class=\\\"token punctuation\\\">:</span> Document\\n            <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n            res<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">send</span><span class=\\\"token punctuation\\\">(</span>html<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n        <span class=\\\"token punctuation\\\">}</span> <span class=\\\"token keyword\\\">catch</span> <span class=\\\"token punctuation\\\">(</span>error<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token punctuation\\\">{</span>\\n            <span class=\\\"token builtin\\\">console</span><span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">error</span><span class=\\\"token punctuation\\\">(</span>error<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n            res<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">json</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">{</span>message<span class=\\\"token punctuation\\\">:</span> error<span class=\\\"token punctuation\\\">.</span>message<span class=\\\"token punctuation\\\">,</span> stack<span class=\\\"token punctuation\\\">:</span> error<span class=\\\"token punctuation\\\">.</span>stack<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n        <span class=\\\"token punctuation\\\">}</span>\\n    <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n\\n<span class=\\\"token keyword\\\">export</span> <span class=\\\"token keyword\\\">default</span> server<span class=\\\"token punctuation\\\">;</span>\\n\"\n        }\n      }}></code></pre>\n    <p>{`原因是process.env.RAZZLE_CHUNKS_MANIFEST这个环境变量没有被注入，require了个undefined，于是出现了上面的报错。`}</p>\n    <p>{`这算是Razzle从3到4的一个breaking change吧。`}</p>\n    <p>{`我们可以去看`}<a parentName=\"p\" {...{\n        \"href\": \"https://sourcegraph.com/github.com/jaredpalmer/razzle@refs/tags/v3.4.5/-/blob/packages/razzle/config/env.js?L56:9\"\n      }}>{`V3`}</a></p>\n    <p>{`是从`}<a parentName=\"p\" {...{\n        \"href\": \"https://sourcegraph.com/github.com/jaredpalmer/razzle@refs/tags/v3.4.5/-/blob/packages/razzle/config/createConfig.js?L15:7\"\n      }}>{`crateConfig`}</a>{`调用了来自`}<a parentName=\"p\" {...{\n        \"href\": \"https://sourcegraph.com/github.com/jaredpalmer/razzle@refs/tags/v3.4.5/-/blob/packages/razzle/config/paths.js\"\n      }}>{`paths`}</a>{`的`}<inlineCode parentName=\"p\">{`build/chunks.json`}</inlineCode>{`文件`}</p>\n    <p>{`那怎么办呢？这个点在razzle官网的plugin的doc上并没有说明。导致用After的我当时一脸懵逼。并不知道这个东西独立成插件了。`}</p>\n    <p>{`但是我们去`}<a parentName=\"p\" {...{\n        \"href\": \"https://sourcegraph.com/github.com/jaredpalmer/razzle/-/blob/packages/razzle-plugin-manifest/index.js?L79:22\"\n      }}>{`V4`}</a>{`看代码，发现仓库里确实有这么一个razzle-plugin-manifest这个插件，它就是做这个事情的。`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-ts\",\n        \"data-language\": \"ts\",\n        \"data-highlighted-line-numbers\": \"\",\n        \"dangerouslySetInnerHTML\": {\n          \"__html\": \" webpackConfig<span class=\\\"token punctuation\\\">.</span>plugins<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">push</span><span class=\\\"token punctuation\\\">(</span>\\n      <span class=\\\"token keyword\\\">new</span> <span class=\\\"token class-name\\\">webpackObject<span class=\\\"token punctuation\\\">.</span>DefinePlugin</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">{</span>\\n        <span class=\\\"token string\\\">'process.env.RAZZLE_CHUNKS_MANIFEST'</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token constant\\\">JSON</span><span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">stringify</span><span class=\\\"token punctuation\\\">(</span>pluginOptions<span class=\\\"token punctuation\\\">.</span>fileName<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">,</span>\\n      <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">)</span>\\n    <span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n\"\n        }\n      }}></code></pre>\n    <h3 {...{\n      \"id\": \"解决问题\"\n    }}>{`解决问题`}</h3>\n    <p>{`可以在After的官网examples里面看到这个例子`}<a parentName=\"p\" {...{\n        \"href\": \"https://github.com/jaredpalmer/after.js/tree/master/examples/basic\"\n      }}>{`basic`}</a></p>\n    <p>{`它使用的唯一的razzle插件就是manifest。`}</p>\n    <p>{`那么解决这个问题的办法就是装上这个插件。`}</p>\n    <p>{`安装`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-bash\",\n        \"data-language\": \"bash\",\n        \"data-highlighted-line-numbers\": \"\",\n        \"dangerouslySetInnerHTML\": {\n          \"__html\": \"<span class=\\\"token function\\\">yarn</span> <span class=\\\"token function\\\">add</span> --dev razzle-plugin-manifest\\n\"\n        }\n      }}></code></pre>\n    <p>{`应用插件`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-jsx\",\n        \"data-language\": \"jsx\",\n        \"data-highlighted-line-numbers\": \"\",\n        \"dangerouslySetInnerHTML\": {\n          \"__html\": \"<span class=\\\"token comment\\\">// razzle.config.js</span>\\nmodule<span class=\\\"token punctuation\\\">.</span>exports <span class=\\\"token operator\\\">=</span> <span class=\\\"token punctuation\\\">{</span>\\n  plugins<span class=\\\"token punctuation\\\">:</span> <span class=\\\"token punctuation\\\">[</span><span class=\\\"token string\\\">'manifest'</span><span class=\\\"token punctuation\\\">]</span><span class=\\\"token punctuation\\\">,</span>\\n<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">;</span>\\n\"\n        }\n      }}></code></pre>\n    <p>{`然后就可以跑了`}</p>\n    <h2 {...{\n      \"id\": \"总结\"\n    }}>{`总结`}</h2>\n    <p>{`升级的时候出现一些问题，需要细心定位，步步为营。`}</p>\n    </MDXLayout>;\n}\n\n;\nMDXContent.isMDXComponent = true;\nexport const tableOfContents = (components={}) => [\n  {\n    id: \"你可以从本文了解到\",\n    level: 2,\n    title: \"你可以从本文了解到\",\n    children: [\n        \n      ]\n  },\n{\n    id: \"背景\",\n    level: 2,\n    title: \"背景\",\n    children: [\n        \n      ]\n  },\n{\n    id: \"过程和遇到问题\",\n    level: 2,\n    title: \"过程和遇到问题\",\n    children: [\n        {\n              id: \"更新依赖\",\n              level: 3,\n              title: \"更新依赖\",\n              children: [\n                      \n                    ]\n            },\n      {\n              id: \"解决问题\",\n              level: 3,\n              title: \"解决问题\",\n              children: [\n                      \n                    ]\n            }\n      ]\n  },\n{\n    id: \"总结\",\n    level: 2,\n    title: \"总结\",\n    children: [\n        \n      ]\n  }\n]\n\nexport const frontMatter = {}\n\n"],"sourceRoot":""}