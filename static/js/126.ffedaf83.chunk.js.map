{"version":3,"sources":["routes/posts/2021/12/27-1728-Two-History-Bug/document.mdx"],"names":["readingTime","text","minutes","time","words","layoutProps","MDXLayout","MDXContent","_ref","components","props","Object","_home_runner_work_mzvast_github_io_mzvast_github_io_node_modules_babel_preset_react_app_node_modules_babel_runtime_helpers_esm_objectWithoutProperties__WEBPACK_IMPORTED_MODULE_0__","_mdx_js_react__WEBPACK_IMPORTED_MODULE_2__","assign","mdxType","id","parentName","href","className","data-language","data-highlighted-line-numbers","dangerouslySetInnerHTML","__html","isMDXComponent","tableOfContents","arguments","length","undefined","level","title","children","frontMatter"],"mappings":"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","file":"static/js/126.ffedaf83.chunk.js","sourcesContent":["\nimport React from 'react'\nimport { mdx } from '@mdx-js/react'\nexport const readingTime = {\"text\":\"4 min read\",\"minutes\":3.815,\"time\":228900,\"words\":763}\n/* @jsx mdx */\n\n\nconst makeShortcode = name => function MDXDefaultShortcode(props) {\n  console.warn(\"Component \" + name + \" was not imported, exported, or provided by MDXProvider as global scope\")\n  return <div {...props}/>\n};\n\nconst layoutProps = {\n  \n};\nconst MDXLayout = \"wrapper\"\nexport default function MDXContent({\n  components,\n  ...props\n}) {\n  return <MDXLayout {...layoutProps} {...props} components={components} mdxType=\"MDXLayout\">\n    <h2 {...{\n      \"id\": \"你可以从本文了解到\"\n    }}>{`你可以从本文了解到`}</h2>\n    <h3 {...{\n      \"id\": \"背景\"\n    }}>{`背景`}</h3>\n    <p>{`有一个项目，在做 UT 改造的时候。由于组件经常会对 history 的进行操作(push、replace 等)，为了方便测试，决定对其功能收口。\n也参考了一些开源项目，尤其是`}<a parentName=\"p\" {...{\n        \"href\": \"https://github.com/mattermost/mattermost-webapp\"\n      }}>{`mattermost-app`}</a>{`。其中`}<inlineCode parentName=\"p\">{`utils/browser_history.jsx`}</inlineCode>{`模块就是一个典型的例子。\n他有一个`}<a parentName=\"p\" {...{\n        \"href\": \"https://github.com/mattermost/mattermost-webapp/blob/master/utils/browser_history.jsx\"\n      }}>{`browser_history 模块`}</a></p>\n    <p>{`可以看到它主要做了两件事`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-tsx\",\n        \"data-language\": \"tsx\",\n        \"data-highlighted-line-numbers\": \"\",\n        \"dangerouslySetInnerHTML\": {\n          \"__html\": \"<span class=\\\"token keyword\\\">import</span> <span class=\\\"token punctuation\\\">{</span>createBrowserHistory<span class=\\\"token punctuation\\\">}</span> <span class=\\\"token keyword\\\">from</span> <span class=\\\"token string\\\">'history'</span><span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"token comment\\\">// 实例化一个history</span>\\n<span class=\\\"token keyword\\\">const</span> b <span class=\\\"token operator\\\">=</span> <span class=\\\"token function\\\">createBrowserHistory</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">{</span>basename<span class=\\\"token punctuation\\\">:</span> window<span class=\\\"token punctuation\\\">.</span>basename<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n\\n<span class=\\\"token comment\\\">// 劫持其push方法，返回一个新的history对象（内容是shallow copy了b）</span>\\n<span class=\\\"token keyword\\\">export</span> <span class=\\\"token keyword\\\">const</span> browserHistory <span class=\\\"token operator\\\">=</span> <span class=\\\"token punctuation\\\">{</span>\\n    <span class=\\\"token operator\\\">...</span>b<span class=\\\"token punctuation\\\">,</span>\\n    <span class=\\\"token function-variable function\\\">push</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token punctuation\\\">(</span><span class=\\\"token parameter\\\">path<span class=\\\"token punctuation\\\">,</span> <span class=\\\"token operator\\\">...</span>args</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n        <span class=\\\"token keyword\\\">if</span> <span class=\\\"token punctuation\\\">(</span>isDesktop<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token punctuation\\\">{</span>\\n            <span class=\\\"token comment\\\">// ...</span>\\n        <span class=\\\"token punctuation\\\">}</span> <span class=\\\"token keyword\\\">else</span> <span class=\\\"token punctuation\\\">{</span>\\n            b<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">push</span><span class=\\\"token punctuation\\\">(</span>path<span class=\\\"token punctuation\\\">,</span> <span class=\\\"token operator\\\">...</span>args<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n        <span class=\\\"token punctuation\\\">}</span>\\n    <span class=\\\"token punctuation\\\">}</span>\\n<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">;</span>\\n\"\n        }\n      }}></code></pre>\n    <p>{`我们也模仿着在项目中新建一个`}<inlineCode parentName=\"p\">{`utils/browserHistory.ts`}</inlineCode>{`模块，将从此模块导出 app 全局共享的 history（想法很美好哇）。\n然后在 app 主入口注入这个 history 给 ReactRouter`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-tsx\",\n        \"data-language\": \"tsx\",\n        \"data-highlighted-line-numbers\": \"\",\n        \"dangerouslySetInnerHTML\": {\n          \"__html\": \"<span class=\\\"token keyword\\\">import</span> React<span class=\\\"token punctuation\\\">,</span> <span class=\\\"token punctuation\\\">{</span>Suspense<span class=\\\"token punctuation\\\">}</span> <span class=\\\"token keyword\\\">from</span> <span class=\\\"token string\\\">'react'</span><span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"token keyword\\\">import</span> <span class=\\\"token punctuation\\\">{</span>Router<span class=\\\"token punctuation\\\">,</span> Redirect<span class=\\\"token punctuation\\\">,</span> Route<span class=\\\"token punctuation\\\">,</span> Switch<span class=\\\"token punctuation\\\">}</span> <span class=\\\"token keyword\\\">from</span> <span class=\\\"token string\\\">'react-router-dom'</span><span class=\\\"token punctuation\\\">;</span>\\n\\n<span class=\\\"token keyword\\\">import</span> NotFound <span class=\\\"token keyword\\\">from</span> <span class=\\\"token string\\\">'pages/error/NotFound'</span><span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"token keyword\\\">import</span> <span class=\\\"token punctuation\\\">{</span>browserHistory<span class=\\\"token punctuation\\\">}</span> <span class=\\\"token keyword\\\">from</span> <span class=\\\"token string\\\">'utils/browserHistory'</span><span class=\\\"token punctuation\\\">;</span>\\n\\n<span class=\\\"token keyword\\\">import</span> <span class=\\\"token punctuation\\\">{</span>routes<span class=\\\"token punctuation\\\">}</span> <span class=\\\"token keyword\\\">from</span> <span class=\\\"token string\\\">'./routes'</span><span class=\\\"token punctuation\\\">;</span>\\n\\n<span class=\\\"token comment\\\">/* Use components to define routes */</span>\\n<span class=\\\"token keyword\\\">const</span> <span class=\\\"token function-variable function\\\">App</span> <span class=\\\"token operator\\\">=</span> <span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">(</span>\\n<span class=\\\"highlighted-line\\\">    <span class=\\\"token tag\\\"><span class=\\\"token tag\\\"><span class=\\\"token punctuation\\\">&lt;</span><span class=\\\"token class-name\\\">Router</span></span> <span class=\\\"token attr-name\\\">history</span><span class=\\\"token script language-javascript\\\"><span class=\\\"token script-punctuation punctuation\\\">=</span><span class=\\\"token punctuation\\\">{</span>browserHistory<span class=\\\"token punctuation\\\">}</span></span><span class=\\\"token punctuation\\\">></span></span><span class=\\\"token plain-text\\\"></span></span><span class=\\\"token plain-text\\\">        </span><span class=\\\"token tag\\\"><span class=\\\"token tag\\\"><span class=\\\"token punctuation\\\">&lt;</span><span class=\\\"token class-name\\\">Suspense</span></span> <span class=\\\"token attr-name\\\">fallback</span><span class=\\\"token script language-javascript\\\"><span class=\\\"token script-punctuation punctuation\\\">=</span><span class=\\\"token punctuation\\\">{</span><span class=\\\"token keyword\\\">null</span><span class=\\\"token punctuation\\\">}</span></span><span class=\\\"token punctuation\\\">></span></span><span class=\\\"token plain-text\\\"></span>\\n<span class=\\\"token plain-text\\\">            </span><span class=\\\"token tag\\\"><span class=\\\"token tag\\\"><span class=\\\"token punctuation\\\">&lt;</span><span class=\\\"token class-name\\\">Switch</span></span><span class=\\\"token punctuation\\\">></span></span><span class=\\\"token plain-text\\\"></span>\\n<span class=\\\"token plain-text\\\">                </span><span class=\\\"token punctuation\\\">{</span>routes<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">map</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token parameter\\\">route</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n                    <span class=\\\"token keyword\\\">return</span> <span class=\\\"token punctuation\\\">(</span>\\n                        <span class=\\\"token tag\\\"><span class=\\\"token tag\\\"><span class=\\\"token punctuation\\\">&lt;</span><span class=\\\"token class-name\\\">Route</span></span>\\n                            <span class=\\\"token attr-name\\\">key</span><span class=\\\"token script language-javascript\\\"><span class=\\\"token script-punctuation punctuation\\\">=</span><span class=\\\"token punctuation\\\">{</span>route<span class=\\\"token punctuation\\\">.</span>path<span class=\\\"token punctuation\\\">}</span></span>\\n                            <span class=\\\"token attr-name\\\">path</span><span class=\\\"token script language-javascript\\\"><span class=\\\"token script-punctuation punctuation\\\">=</span><span class=\\\"token punctuation\\\">{</span>route<span class=\\\"token punctuation\\\">.</span>path<span class=\\\"token punctuation\\\">}</span></span>\\n                            <span class=\\\"token attr-name\\\">component</span><span class=\\\"token script language-javascript\\\"><span class=\\\"token script-punctuation punctuation\\\">=</span><span class=\\\"token punctuation\\\">{</span>route<span class=\\\"token punctuation\\\">.</span>component<span class=\\\"token punctuation\\\">}</span></span>\\n                            <span class=\\\"token attr-name\\\">exact</span><span class=\\\"token script language-javascript\\\"><span class=\\\"token script-punctuation punctuation\\\">=</span><span class=\\\"token punctuation\\\">{</span>route<span class=\\\"token punctuation\\\">.</span>exact<span class=\\\"token punctuation\\\">}</span></span>\\n                        <span class=\\\"token punctuation\\\">></span></span><span class=\\\"token tag\\\"><span class=\\\"token tag\\\"><span class=\\\"token punctuation\\\">&lt;/</span><span class=\\\"token class-name\\\">Route</span></span><span class=\\\"token punctuation\\\">></span></span>\\n                    <span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n                <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">}</span><span class=\\\"token plain-text\\\"></span>\\n<span class=\\\"token plain-text\\\">                </span><span class=\\\"token punctuation\\\">{</span><span class=\\\"token comment\\\">/* 找不到，不要跳走去默认页面，否则缓存无法及时更新（用户可以停留在出错页面，刷新来获取新页面） */</span><span class=\\\"token punctuation\\\">}</span><span class=\\\"token plain-text\\\"></span>\\n<span class=\\\"token plain-text\\\">                </span><span class=\\\"token tag\\\"><span class=\\\"token tag\\\"><span class=\\\"token punctuation\\\">&lt;</span><span class=\\\"token class-name\\\">Route</span></span> <span class=\\\"token attr-name\\\">path</span><span class=\\\"token script language-javascript\\\"><span class=\\\"token script-punctuation punctuation\\\">=</span><span class=\\\"token punctuation\\\">{</span><span class=\\\"token string\\\">'*'</span><span class=\\\"token punctuation\\\">}</span></span> <span class=\\\"token attr-name\\\">component</span><span class=\\\"token script language-javascript\\\"><span class=\\\"token script-punctuation punctuation\\\">=</span><span class=\\\"token punctuation\\\">{</span>NotFound<span class=\\\"token punctuation\\\">}</span></span><span class=\\\"token punctuation\\\">></span></span><span class=\\\"token tag\\\"><span class=\\\"token tag\\\"><span class=\\\"token punctuation\\\">&lt;/</span><span class=\\\"token class-name\\\">Route</span></span><span class=\\\"token punctuation\\\">></span></span><span class=\\\"token plain-text\\\"></span>\\n<span class=\\\"token plain-text\\\">            </span><span class=\\\"token tag\\\"><span class=\\\"token tag\\\"><span class=\\\"token punctuation\\\">&lt;/</span><span class=\\\"token class-name\\\">Switch</span></span><span class=\\\"token punctuation\\\">></span></span><span class=\\\"token plain-text\\\"></span>\\n<span class=\\\"token plain-text\\\">        </span><span class=\\\"token tag\\\"><span class=\\\"token tag\\\"><span class=\\\"token punctuation\\\">&lt;/</span><span class=\\\"token class-name\\\">Suspense</span></span><span class=\\\"token punctuation\\\">></span></span><span class=\\\"token plain-text\\\"></span>\\n<span class=\\\"token plain-text\\\">    </span><span class=\\\"token tag\\\"><span class=\\\"token tag\\\"><span class=\\\"token punctuation\\\">&lt;/</span><span class=\\\"token class-name\\\">Router</span></span><span class=\\\"token punctuation\\\">></span></span>\\n<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"token keyword\\\">export</span> <span class=\\\"token keyword\\\">default</span> App<span class=\\\"token punctuation\\\">;</span>\\n\"\n        }\n      }}></code></pre>\n    <h3 {...{\n      \"id\": \"bug-被发现\"\n    }}>{`bug 被发现`}</h3>\n    <p>{`然后比如我们在另一个组件里面去用这个 location 值。从其他页面跳转到新页面。这个页面如下。`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-tsx\",\n        \"data-language\": \"tsx\",\n        \"data-highlighted-line-numbers\": \"\",\n        \"dangerouslySetInnerHTML\": {\n          \"__html\": \"<span class=\\\"token keyword\\\">const</span> PrivateComp<span class=\\\"token punctuation\\\">:</span> React<span class=\\\"token punctuation\\\">.</span><span class=\\\"token constant\\\">FC</span><span class=\\\"token tag\\\"><span class=\\\"token tag\\\"><span class=\\\"token punctuation\\\">&lt;</span><span class=\\\"token class-name\\\">Props</span></span><span class=\\\"token punctuation\\\">></span></span><span class=\\\"token plain-text\\\"> = ({children}) => </span><span class=\\\"token punctuation\\\">{</span>\\n    <span class=\\\"token keyword\\\">const</span> <span class=\\\"token punctuation\\\">{</span>pathname<span class=\\\"token punctuation\\\">}</span> <span class=\\\"token operator\\\">=</span> <span class=\\\"token function\\\">useHistory</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">.</span>location<span class=\\\"token punctuation\\\">;</span> <span class=\\\"token comment\\\">// 来自useHistory的location值</span>\\n    <span class=\\\"token keyword\\\">const</span> location <span class=\\\"token operator\\\">=</span> <span class=\\\"token function\\\">useLocation</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span> <span class=\\\"token comment\\\">// 来自useLocation的location值</span>\\n    <span class=\\\"token keyword\\\">const</span> currentUrl <span class=\\\"token operator\\\">=</span> location<span class=\\\"token punctuation\\\">.</span>pathname<span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"highlighted-line\\\">    <span class=\\\"token builtin\\\">console</span><span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">log</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token string\\\">'ddt::pathname,currentUrl'</span><span class=\\\"token punctuation\\\">,</span> pathname<span class=\\\"token punctuation\\\">,</span> currentUrl<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span></span><span class=\\\"highlighted-line\\\">    <span class=\\\"token comment\\\">// ddt::pathname,currentUrl /create2021 /create2021/works</span></span>    <span class=\\\"token keyword\\\">if</span> <span class=\\\"token punctuation\\\">(</span><span class=\\\"token operator\\\">!</span>children<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token keyword\\\">throw</span> <span class=\\\"token keyword\\\">new</span> <span class=\\\"token class-name\\\">Error</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token string\\\">'children must exist'</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n\\n    <span class=\\\"token comment\\\">// onClickCapture 捕获</span>\\n    <span class=\\\"token keyword\\\">return</span> <span class=\\\"token tag\\\"><span class=\\\"token tag\\\"><span class=\\\"token punctuation\\\">&lt;</span>div</span> <span class=\\\"token attr-name\\\">onClickCapture</span><span class=\\\"token script language-javascript\\\"><span class=\\\"token script-punctuation punctuation\\\">=</span><span class=\\\"token punctuation\\\">{</span>handleClick<span class=\\\"token punctuation\\\">}</span></span><span class=\\\"token punctuation\\\">></span></span><span class=\\\"token punctuation\\\">{</span>children<span class=\\\"token punctuation\\\">}</span><span class=\\\"token tag\\\"><span class=\\\"token tag\\\"><span class=\\\"token punctuation\\\">&lt;/</span>div</span><span class=\\\"token punctuation\\\">></span></span><span class=\\\"token punctuation\\\">;</span>\\n\\n    <span class=\\\"token keyword\\\">function</span> <span class=\\\"token function\\\">handleClick</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token parameter\\\">e<span class=\\\"token punctuation\\\">:</span> React<span class=\\\"token punctuation\\\">.</span>MouseEvent</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token punctuation\\\">{</span>\\n        <span class=\\\"token comment\\\">// ...</span>\\n    <span class=\\\"token punctuation\\\">}</span>\\n<span class=\\\"token punctuation\\\">}</span><span class=\\\"token plain-text\\\">;</span>\\n<span class=\\\"token plain-text\\\">export default PrivateComp;</span>\\n<span class=\\\"token plain-text\\\"></span>\"\n        }\n      }}></code></pre>\n    <p>{`可以看到打印结果的两个 location 不一样。这是为什么呢？`}</p>\n    <h3 {...{\n      \"id\": \"原因定位和解决\"\n    }}>{`原因定位和解决`}</h3>\n    <p>{`首先我们的 browserHistory 是基本上 copy 的 mattermost 的，人家没遇到bug么。`}</p>\n    <p>{`那么顺着这个思路我们去捋一下这个 bug。`}</p>\n    <p>{`我们放慢一点`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-tsx\",\n        \"data-language\": \"tsx\",\n        \"data-highlighted-line-numbers\": \"\",\n        \"dangerouslySetInnerHTML\": {\n          \"__html\": \"<span class=\\\"token keyword\\\">import</span> <span class=\\\"token punctuation\\\">{</span>createBrowserHistory<span class=\\\"token punctuation\\\">}</span> <span class=\\\"token keyword\\\">from</span> <span class=\\\"token string\\\">'history'</span><span class=\\\"token punctuation\\\">;</span>\\n\\n<span class=\\\"token keyword\\\">import</span> pathConfig <span class=\\\"token keyword\\\">from</span> <span class=\\\"token string\\\">'config/pathConfig'</span><span class=\\\"token punctuation\\\">;</span>\\n\\n<span class=\\\"token keyword\\\">const</span> b <span class=\\\"token operator\\\">=</span> createBrowserHistory<span class=\\\"token tag\\\"><span class=\\\"token tag\\\"><span class=\\\"token punctuation\\\">&lt;</span>any</span><span class=\\\"token punctuation\\\">></span></span><span class=\\\"token plain-text\\\">(</span><span class=\\\"token punctuation\\\">{</span>basename<span class=\\\"token punctuation\\\">:</span> pathConfig<span class=\\\"token punctuation\\\">.</span><span class=\\\"token constant\\\">BASENAME</span><span class=\\\"token punctuation\\\">}</span><span class=\\\"token plain-text\\\">);\\n\\n// bug case\\nexport const c = </span><span class=\\\"token punctuation\\\">{</span>\\n    <span class=\\\"token operator\\\">...</span>b<span class=\\\"token punctuation\\\">,</span>\\n    <span class=\\\"token function-variable function\\\">push</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token punctuation\\\">(</span><span class=\\\"token parameter\\\">path<span class=\\\"token punctuation\\\">,</span> <span class=\\\"token operator\\\">...</span>args</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n        <span class=\\\"token builtin\\\">console</span><span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">log</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token string\\\">'browserHistory::push'</span><span class=\\\"token punctuation\\\">,</span> path<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n        <span class=\\\"token comment\\\">//@ts-ignore</span>\\n        <span class=\\\"token keyword\\\">return</span> b<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">push</span><span class=\\\"token punctuation\\\">(</span>path<span class=\\\"token punctuation\\\">,</span> <span class=\\\"token operator\\\">...</span>args<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n    <span class=\\\"token punctuation\\\">}</span>\\n<span class=\\\"token punctuation\\\">}</span><span class=\\\"token plain-text\\\">;\\nexport default c;\\n</span>\"\n        }\n      }}></code></pre>\n    <p>{`可以看到 c 的 push 方法修改的是 b 对象。而我们传给 Router 的是 c。`}</p>\n    <p>{`我们先看看 history 这个包的 push 方法做了什么。`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-ts\",\n        \"data-language\": \"ts\",\n        \"data-highlighted-line-numbers\": \"\",\n        \"dangerouslySetInnerHTML\": {\n          \"__html\": \"<span class=\\\"token keyword\\\">function</span> <span class=\\\"token function\\\">push</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token parameter\\\">path<span class=\\\"token punctuation\\\">,</span> state</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token punctuation\\\">{</span>\\n    process<span class=\\\"token punctuation\\\">.</span>env<span class=\\\"token punctuation\\\">.</span><span class=\\\"token constant\\\">NODE_ENV</span> <span class=\\\"token operator\\\">!==</span> <span class=\\\"token string\\\">'production'</span>\\n        <span class=\\\"token operator\\\">?</span> <span class=\\\"token function\\\">warning</span><span class=\\\"token punctuation\\\">(</span>\\n              <span class=\\\"token operator\\\">!</span><span class=\\\"token punctuation\\\">(</span>\\n                  <span class=\\\"token keyword\\\">typeof</span> path <span class=\\\"token operator\\\">===</span> <span class=\\\"token string\\\">'object'</span> <span class=\\\"token operator\\\">&amp;&amp;</span>\\n                  path<span class=\\\"token punctuation\\\">.</span>state <span class=\\\"token operator\\\">!==</span> undefined <span class=\\\"token operator\\\">&amp;&amp;</span>\\n                  state <span class=\\\"token operator\\\">!==</span> undefined\\n              <span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">,</span>\\n              <span class=\\\"token string\\\">'You should avoid providing a 2nd state argument to push when the 1st '</span> <span class=\\\"token operator\\\">+</span>\\n                  <span class=\\\"token string\\\">'argument is a location-like object that already has state; it is ignored'</span>\\n          <span class=\\\"token punctuation\\\">)</span>\\n        <span class=\\\"token punctuation\\\">:</span> <span class=\\\"token keyword\\\">void</span> <span class=\\\"token number\\\">0</span><span class=\\\"token punctuation\\\">;</span>\\n    <span class=\\\"token keyword\\\">var</span> action <span class=\\\"token operator\\\">=</span> <span class=\\\"token string\\\">'PUSH'</span><span class=\\\"token punctuation\\\">;</span>\\n    <span class=\\\"token keyword\\\">var</span> location <span class=\\\"token operator\\\">=</span> <span class=\\\"token function\\\">createLocation</span><span class=\\\"token punctuation\\\">(</span>path<span class=\\\"token punctuation\\\">,</span> state<span class=\\\"token punctuation\\\">,</span> <span class=\\\"token function\\\">createKey</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">,</span> history<span class=\\\"token punctuation\\\">.</span>location<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n    transitionManager<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">confirmTransitionTo</span><span class=\\\"token punctuation\\\">(</span>\\n        location<span class=\\\"token punctuation\\\">,</span>\\n        action<span class=\\\"token punctuation\\\">,</span>\\n        getUserConfirmation<span class=\\\"token punctuation\\\">,</span>\\n        <span class=\\\"token keyword\\\">function</span> <span class=\\\"token punctuation\\\">(</span><span class=\\\"token parameter\\\">ok</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token punctuation\\\">{</span>\\n            <span class=\\\"token keyword\\\">if</span> <span class=\\\"token punctuation\\\">(</span><span class=\\\"token operator\\\">!</span>ok<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token keyword\\\">return</span><span class=\\\"token punctuation\\\">;</span>\\n            <span class=\\\"token keyword\\\">var</span> href <span class=\\\"token operator\\\">=</span> <span class=\\\"token function\\\">createHref</span><span class=\\\"token punctuation\\\">(</span>location<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n            <span class=\\\"token keyword\\\">var</span> key <span class=\\\"token operator\\\">=</span> location<span class=\\\"token punctuation\\\">.</span>key<span class=\\\"token punctuation\\\">,</span>\\n                state <span class=\\\"token operator\\\">=</span> location<span class=\\\"token punctuation\\\">.</span>state<span class=\\\"token punctuation\\\">;</span>\\n\\n            <span class=\\\"token keyword\\\">if</span> <span class=\\\"token punctuation\\\">(</span>canUseHistory<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token punctuation\\\">{</span>\\n                <span class=\\\"token comment\\\">// 更新window.history对象（全局的）</span>\\n<span class=\\\"highlighted-line\\\">                globalHistory<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">pushState</span><span class=\\\"token punctuation\\\">(</span></span>                    <span class=\\\"token punctuation\\\">{</span>\\n                        key<span class=\\\"token punctuation\\\">:</span> key<span class=\\\"token punctuation\\\">,</span>\\n                        state<span class=\\\"token punctuation\\\">:</span> state\\n                    <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">,</span>\\n                    <span class=\\\"token keyword\\\">null</span><span class=\\\"token punctuation\\\">,</span>\\n                    href\\n                <span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n\\n                <span class=\\\"token keyword\\\">if</span> <span class=\\\"token punctuation\\\">(</span>forceRefresh<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token punctuation\\\">{</span>\\n                    window<span class=\\\"token punctuation\\\">.</span>location<span class=\\\"token punctuation\\\">.</span>href <span class=\\\"token operator\\\">=</span> href<span class=\\\"token punctuation\\\">;</span>\\n                <span class=\\\"token punctuation\\\">}</span> <span class=\\\"token keyword\\\">else</span> <span class=\\\"token punctuation\\\">{</span>\\n                    <span class=\\\"token keyword\\\">var</span> prevIndex <span class=\\\"token operator\\\">=</span> allKeys<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">indexOf</span><span class=\\\"token punctuation\\\">(</span>history<span class=\\\"token punctuation\\\">.</span>location<span class=\\\"token punctuation\\\">.</span>key<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n                    <span class=\\\"token keyword\\\">var</span> nextKeys <span class=\\\"token operator\\\">=</span> allKeys<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">slice</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token number\\\">0</span><span class=\\\"token punctuation\\\">,</span> prevIndex <span class=\\\"token operator\\\">+</span> <span class=\\\"token number\\\">1</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n                    nextKeys<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">push</span><span class=\\\"token punctuation\\\">(</span>location<span class=\\\"token punctuation\\\">.</span>key<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n                    allKeys <span class=\\\"token operator\\\">=</span> nextKeys<span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"highlighted-line\\\">                    <span class=\\\"token function\\\">setState</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">{</span></span>                        action<span class=\\\"token punctuation\\\">:</span> action<span class=\\\"token punctuation\\\">,</span>\\n                        location<span class=\\\"token punctuation\\\">:</span> location\\n                    <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span> <span class=\\\"token comment\\\">// 更新history对象</span>\\n                <span class=\\\"token punctuation\\\">}</span>\\n            <span class=\\\"token punctuation\\\">}</span> <span class=\\\"token keyword\\\">else</span> <span class=\\\"token punctuation\\\">{</span>\\n                process<span class=\\\"token punctuation\\\">.</span>env<span class=\\\"token punctuation\\\">.</span><span class=\\\"token constant\\\">NODE_ENV</span> <span class=\\\"token operator\\\">!==</span> <span class=\\\"token string\\\">'production'</span>\\n                    <span class=\\\"token operator\\\">?</span> <span class=\\\"token function\\\">warning</span><span class=\\\"token punctuation\\\">(</span>\\n                          state <span class=\\\"token operator\\\">===</span> undefined<span class=\\\"token punctuation\\\">,</span>\\n                          <span class=\\\"token string\\\">'Browser history cannot push state in browsers that do not support HTML5 history'</span>\\n                      <span class=\\\"token punctuation\\\">)</span>\\n                    <span class=\\\"token punctuation\\\">:</span> <span class=\\\"token keyword\\\">void</span> <span class=\\\"token number\\\">0</span><span class=\\\"token punctuation\\\">;</span>\\n                window<span class=\\\"token punctuation\\\">.</span>location<span class=\\\"token punctuation\\\">.</span>href <span class=\\\"token operator\\\">=</span> href<span class=\\\"token punctuation\\\">;</span>\\n            <span class=\\\"token punctuation\\\">}</span>\\n        <span class=\\\"token punctuation\\\">}</span>\\n    <span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"token punctuation\\\">}</span>\\n\"\n        }\n      }}></code></pre>\n    <p>{`可以看到会更新这个 history 对象 `}</p>\n    <p>{`setState 方法如下`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-ts\",\n        \"data-language\": \"ts\",\n        \"data-highlighted-line-numbers\": \"\",\n        \"dangerouslySetInnerHTML\": {\n          \"__html\": \"<span class=\\\"token keyword\\\">function</span> <span class=\\\"token function\\\">setState</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token parameter\\\">nextState</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token punctuation\\\">{</span>\\n    <span class=\\\"token function\\\">_extends</span><span class=\\\"token punctuation\\\">(</span>history<span class=\\\"token punctuation\\\">,</span> nextState<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n\\n    history<span class=\\\"token punctuation\\\">.</span>length <span class=\\\"token operator\\\">=</span> globalHistory<span class=\\\"token punctuation\\\">.</span>length<span class=\\\"token punctuation\\\">;</span>\\n    transitionManager<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">notifyListeners</span><span class=\\\"token punctuation\\\">(</span>history<span class=\\\"token punctuation\\\">.</span>location<span class=\\\"token punctuation\\\">,</span> history<span class=\\\"token punctuation\\\">.</span>action<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"token punctuation\\\">}</span>\\n\"\n        }\n      }}></code></pre>\n    <p>{`所以这解释了为什么 useHistory 的 location 没变。（c 没变，b 变了，传给 router 的是吧 c）。`}</p>\n    <p>{`至此问题解开了一半。`}</p>\n    <p>{`那么为什么 useLocation 的 pathname 变了？`}</p>\n    <p>{`我们去看 ReactRouter 的 Router 的构造函数`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-tsx\",\n        \"data-language\": \"tsx\",\n        \"data-highlighted-line-numbers\": \"\",\n        \"dangerouslySetInnerHTML\": {\n          \"__html\": \"<span class=\\\"token comment\\\">// packages/react-router/modules/Router.js</span>\\n<span class=\\\"token keyword\\\">class</span> <span class=\\\"token class-name\\\">Router</span> <span class=\\\"token keyword\\\">extends</span> <span class=\\\"token class-name\\\">React<span class=\\\"token punctuation\\\">.</span>Component</span> <span class=\\\"token punctuation\\\">{</span>\\n    <span class=\\\"token keyword\\\">constructor</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token parameter\\\">props</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token punctuation\\\">{</span>\\n        <span class=\\\"token keyword\\\">super</span><span class=\\\"token punctuation\\\">(</span>props<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n\\n        <span class=\\\"token keyword\\\">this</span><span class=\\\"token punctuation\\\">.</span>state <span class=\\\"token operator\\\">=</span> <span class=\\\"token punctuation\\\">{</span>\\n<span class=\\\"highlighted-line\\\">            location<span class=\\\"token punctuation\\\">:</span> props<span class=\\\"token punctuation\\\">.</span>history<span class=\\\"token punctuation\\\">.</span>location <span class=\\\"token comment\\\">// 内部维护了一份location</span></span>        <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">;</span>\\n\\n        <span class=\\\"token comment\\\">// This is a bit of a hack. We have to start listening for location</span>\\n        <span class=\\\"token comment\\\">// changes here in the constructor in case there are any &lt;Redirect>s</span>\\n        <span class=\\\"token comment\\\">// on the initial render. If there are, they will replace/push when</span>\\n        <span class=\\\"token comment\\\">// they mount and since cDM fires in children before parents, we may</span>\\n        <span class=\\\"token comment\\\">// get a new location before the &lt;Router> is mounted.</span>\\n        <span class=\\\"token keyword\\\">this</span><span class=\\\"token punctuation\\\">.</span>_isMounted <span class=\\\"token operator\\\">=</span> <span class=\\\"token boolean\\\">false</span><span class=\\\"token punctuation\\\">;</span>\\n        <span class=\\\"token keyword\\\">this</span><span class=\\\"token punctuation\\\">.</span>_pendingLocation <span class=\\\"token operator\\\">=</span> <span class=\\\"token keyword\\\">null</span><span class=\\\"token punctuation\\\">;</span>\\n\\n        <span class=\\\"token keyword\\\">if</span> <span class=\\\"token punctuation\\\">(</span><span class=\\\"token operator\\\">!</span>props<span class=\\\"token punctuation\\\">.</span>staticContext<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token punctuation\\\">{</span>\\n<span class=\\\"highlighted-line\\\">            <span class=\\\"token keyword\\\">this</span><span class=\\\"token punctuation\\\">.</span>unlisten <span class=\\\"token operator\\\">=</span> props<span class=\\\"token punctuation\\\">.</span>history<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">listen</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token parameter\\\">location</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span></span>                <span class=\\\"token keyword\\\">if</span> <span class=\\\"token punctuation\\\">(</span><span class=\\\"token keyword\\\">this</span><span class=\\\"token punctuation\\\">.</span>_isMounted<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token punctuation\\\">{</span>\\n                    <span class=\\\"token keyword\\\">this</span><span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">setState</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">{</span>location<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n                <span class=\\\"token punctuation\\\">}</span> <span class=\\\"token keyword\\\">else</span> <span class=\\\"token punctuation\\\">{</span>\\n                    <span class=\\\"token keyword\\\">this</span><span class=\\\"token punctuation\\\">.</span>_pendingLocation <span class=\\\"token operator\\\">=</span> location<span class=\\\"token punctuation\\\">;</span>\\n                <span class=\\\"token punctuation\\\">}</span>\\n            <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n        <span class=\\\"token punctuation\\\">}</span>\\n    <span class=\\\"token punctuation\\\">}</span>\\n\\n    <span class=\\\"token function\\\">render</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token punctuation\\\">{</span>\\n        <span class=\\\"token keyword\\\">return</span> <span class=\\\"token punctuation\\\">(</span>\\n            <span class=\\\"token tag\\\"><span class=\\\"token tag\\\"><span class=\\\"token punctuation\\\">&lt;</span><span class=\\\"token class-name\\\">RouterContext.Provider</span></span>\\n                <span class=\\\"token attr-name\\\">value</span><span class=\\\"token script language-javascript\\\"><span class=\\\"token script-punctuation punctuation\\\">=</span><span class=\\\"token punctuation\\\">{</span><span class=\\\"token punctuation\\\">{</span>\\n                    history<span class=\\\"token punctuation\\\">:</span> <span class=\\\"token keyword\\\">this</span><span class=\\\"token punctuation\\\">.</span>props<span class=\\\"token punctuation\\\">.</span>history<span class=\\\"token punctuation\\\">,</span>\\n<span class=\\\"highlighted-line\\\">                    location<span class=\\\"token punctuation\\\">:</span> <span class=\\\"token keyword\\\">this</span><span class=\\\"token punctuation\\\">.</span>state<span class=\\\"token punctuation\\\">.</span>location<span class=\\\"token punctuation\\\">,</span></span>                    match<span class=\\\"token punctuation\\\">:</span> Router<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">computeRootMatch</span><span class=\\\"token punctuation\\\">(</span>\\n                        <span class=\\\"token keyword\\\">this</span><span class=\\\"token punctuation\\\">.</span>state<span class=\\\"token punctuation\\\">.</span>location<span class=\\\"token punctuation\\\">.</span>pathname\\n                    <span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">,</span>\\n                    staticContext<span class=\\\"token punctuation\\\">:</span> <span class=\\\"token keyword\\\">this</span><span class=\\\"token punctuation\\\">.</span>props<span class=\\\"token punctuation\\\">.</span>staticContext\\n                <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">}</span></span>\\n            <span class=\\\"token punctuation\\\">></span></span><span class=\\\"token plain-text\\\"></span>\\n<span class=\\\"token plain-text\\\">                </span><span class=\\\"token tag\\\"><span class=\\\"token tag\\\"><span class=\\\"token punctuation\\\">&lt;</span><span class=\\\"token class-name\\\">HistoryContext.Provider</span></span>\\n                    <span class=\\\"token attr-name\\\">children</span><span class=\\\"token script language-javascript\\\"><span class=\\\"token script-punctuation punctuation\\\">=</span><span class=\\\"token punctuation\\\">{</span><span class=\\\"token keyword\\\">this</span><span class=\\\"token punctuation\\\">.</span>props<span class=\\\"token punctuation\\\">.</span>children <span class=\\\"token operator\\\">||</span> <span class=\\\"token keyword\\\">null</span><span class=\\\"token punctuation\\\">}</span></span>\\n                    <span class=\\\"token attr-name\\\">value</span><span class=\\\"token script language-javascript\\\"><span class=\\\"token script-punctuation punctuation\\\">=</span><span class=\\\"token punctuation\\\">{</span><span class=\\\"token keyword\\\">this</span><span class=\\\"token punctuation\\\">.</span>props<span class=\\\"token punctuation\\\">.</span>history<span class=\\\"token punctuation\\\">}</span></span>\\n                <span class=\\\"token punctuation\\\">/></span></span><span class=\\\"token plain-text\\\"></span>\\n<span class=\\\"token plain-text\\\">            </span><span class=\\\"token tag\\\"><span class=\\\"token tag\\\"><span class=\\\"token punctuation\\\">&lt;/</span><span class=\\\"token class-name\\\">RouterContext.Provider</span></span><span class=\\\"token punctuation\\\">></span></span>\\n        <span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n    <span class=\\\"token punctuation\\\">}</span>\\n<span class=\\\"token punctuation\\\">}</span>\\n\"\n        }\n      }}></code></pre>\n    <p>{`可以看到 Router 调用了 history 的 listen 方法，将自己注册为观察者。因此 push 方法调用会通知到 Router，从而引起 setState。\n这个 setState 更新自己内部的 location。所以即使绑定错了 history，location 依然会更新。（另一半问题得到了解释）`}</p>\n    <p>{`接着我们看那两个 hooks`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-tsx\",\n        \"data-language\": \"tsx\",\n        \"data-highlighted-line-numbers\": \"\",\n        \"dangerouslySetInnerHTML\": {\n          \"__html\": \"<span class=\\\"token comment\\\">// packages/react-router/modules/hooks.js</span>\\n<span class=\\\"token keyword\\\">import</span> React <span class=\\\"token keyword\\\">from</span> <span class=\\\"token string\\\">'react'</span><span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"token keyword\\\">import</span> invariant <span class=\\\"token keyword\\\">from</span> <span class=\\\"token string\\\">'tiny-invariant'</span><span class=\\\"token punctuation\\\">;</span>\\n\\n<span class=\\\"token keyword\\\">import</span> Context <span class=\\\"token keyword\\\">from</span> <span class=\\\"token string\\\">'./RouterContext.js'</span><span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"token keyword\\\">import</span> HistoryContext <span class=\\\"token keyword\\\">from</span> <span class=\\\"token string\\\">'./HistoryContext.js'</span><span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"token keyword\\\">import</span> matchPath <span class=\\\"token keyword\\\">from</span> <span class=\\\"token string\\\">'./matchPath.js'</span><span class=\\\"token punctuation\\\">;</span>\\n\\n<span class=\\\"token keyword\\\">const</span> useContext <span class=\\\"token operator\\\">=</span> React<span class=\\\"token punctuation\\\">.</span>useContext<span class=\\\"token punctuation\\\">;</span>\\n\\n<span class=\\\"token keyword\\\">export</span> <span class=\\\"token keyword\\\">function</span> <span class=\\\"token function\\\">useHistory</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token punctuation\\\">{</span>\\n<span class=\\\"highlighted-line\\\">    <span class=\\\"token keyword\\\">return</span> <span class=\\\"token function\\\">useContext</span><span class=\\\"token punctuation\\\">(</span>HistoryContext<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span> <span class=\\\"token comment\\\">// 返回注入的history</span></span><span class=\\\"token punctuation\\\">}</span>\\n\\n<span class=\\\"token keyword\\\">export</span> <span class=\\\"token keyword\\\">function</span> <span class=\\\"token function\\\">useLocation</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token punctuation\\\">{</span>\\n<span class=\\\"highlighted-line\\\">    <span class=\\\"token keyword\\\">return</span> <span class=\\\"token function\\\">useContext</span><span class=\\\"token punctuation\\\">(</span>Context<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">.</span>location<span class=\\\"token punctuation\\\">;</span> <span class=\\\"token comment\\\">// 返回Router的state.location</span></span><span class=\\\"token punctuation\\\">}</span>\\n\"\n        }\n      }}></code></pre>\n    <p>{`可见 ReactRouter 用了两个 Context，一个 HistoryContext，一个 RouterContext。\nuseHistory 返回注入的 history，我们注入错了。\nuseLocation 返回 Router 自己维护的 location，与 history 无关，因此一直是对的。`}</p>\n    <p>{`这个问题的解决办法有多种，核心就是就是不要复制 b，而是修改 b 或者通过 proxy 拦截和转发。\n不用proxy的改法如下。`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-tsx\",\n        \"data-language\": \"tsx\",\n        \"data-highlighted-line-numbers\": \"\",\n        \"dangerouslySetInnerHTML\": {\n          \"__html\": \"<span class=\\\"token keyword\\\">const</span> b <span class=\\\"token operator\\\">=</span> createBrowserHistory<span class=\\\"token tag\\\"><span class=\\\"token tag\\\"><span class=\\\"token punctuation\\\">&lt;</span>any</span><span class=\\\"token punctuation\\\">></span></span><span class=\\\"token plain-text\\\">(</span><span class=\\\"token punctuation\\\">{</span>basename<span class=\\\"token punctuation\\\">:</span> pathConfig<span class=\\\"token punctuation\\\">.</span><span class=\\\"token constant\\\">BASENAME</span><span class=\\\"token punctuation\\\">}</span><span class=\\\"token plain-text\\\">);\\nconst _push = b.push; // 保存一份\\nconst browserHistory = b;\\nbrowserHistory.push = (path, ...args) => </span><span class=\\\"token punctuation\\\">{</span>\\n    <span class=\\\"token comment\\\">// 可以打些log啥的</span>\\n    <span class=\\\"token builtin\\\">console</span><span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">log</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token string\\\">'browserHistory::push'</span><span class=\\\"token punctuation\\\">,</span> path<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n    <span class=\\\"token function\\\">_push</span><span class=\\\"token punctuation\\\">(</span>path<span class=\\\"token punctuation\\\">,</span> <span class=\\\"token operator\\\">...</span>args<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"token punctuation\\\">}</span><span class=\\\"token plain-text\\\">;\\n\\nexport </span><span class=\\\"token punctuation\\\">{</span>browserHistory<span class=\\\"token punctuation\\\">}</span><span class=\\\"token plain-text\\\">;\\n</span>\"\n        }\n      }}></code></pre>\n    <h3 {...{\n      \"id\": \"反思\"\n    }}>{`反思`}</h3>\n    <p>{`通过这个bug，我们将history和ReactRouter串联了起来。`}</p>\n    <p>{`mattermost之所以遇到这个bug是因为他们拿pathname永远都是从this.props.location或者useLocation拿。`}</p>\n    <p>{`有机会还是应该把这个bug report给他们的。`}</p>\n    <p>{`教训：copy paste要小心，别把bug copy过来！`}</p>\n    </MDXLayout>;\n}\n\n;\nMDXContent.isMDXComponent = true;\nexport const tableOfContents = (components={}) => [\n  {\n    id: \"你可以从本文了解到\",\n    level: 2,\n    title: \"你可以从本文了解到\",\n    children: [\n        {\n              id: \"背景\",\n              level: 3,\n              title: \"背景\",\n              children: [\n                      \n                    ]\n            },\n      {\n              id: \"bug-被发现\",\n              level: 3,\n              title: \"bug 被发现\",\n              children: [\n                      \n                    ]\n            },\n      {\n              id: \"原因定位和解决\",\n              level: 3,\n              title: \"原因定位和解决\",\n              children: [\n                      \n                    ]\n            },\n      {\n              id: \"反思\",\n              level: 3,\n              title: \"反思\",\n              children: [\n                      \n                    ]\n            }\n      ]\n  }\n]\n\nexport const frontMatter = {}\n\n"],"sourceRoot":""}